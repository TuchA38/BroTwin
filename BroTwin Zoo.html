<!DOCTYPE html>
<html lang="pl-PL">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="Ikony/Planet Zoo.png">
    <title>BroTwin Zoo</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: transparent;
        }
        
        #content-frame {
            position: relative;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            border: none;
            opacity: 1;
            /* widoczny na start */
            transition: opacity 0.2s ease-in-out;
            /* płynna zmiana widoczności */
            background-color: transparent;
            /* np. ten sam kolor co body lub kontener */
        }
        
        #player-frame {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 400px;
            height: 600px;
            border: none;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            opacity: 0;
            /* początkowo niewidoczny */
            transform: scale(0.8);
            /* lekko zmniejszony */
            transition: opacity 0.3s ease, transform 0.3s ease;
            /* animacja */
            pointer-events: none;
            /* nie reaguje gdy jest "zamknięty" */
        }
        /* Kiedy modal jest otwarty */
        
        #player-frame.open {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            /* przyjmuje kliknięcia */
        }
        
        #player-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            /* obok modala */
            z-index: 9998;
            /* przycisk pod modalem */
        }
        
        #player-toggle button {
            background-color: #0a5c3f;
            /* zielone tło */
            color: white;
            border: none;
            border-radius: 50%;
            opacity: 90%;
            /* okrągły kształt */
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            /* rozmiar ikony */
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #player-toggle button:hover {
            transform: scale(1.1);
            opacity: 100%;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        #player-frame.minimized {
            height: 80px;
            width: 350px;
        }
        
        #player-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        #player-controls button {
            background: #0a5c3f;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
    </style>
    <style>
        /* Responsywny modal i przycisk dla telefonów */
        
        @media (max-height: 400px) {
            #player-frame {
                width: 300px;
                /* węższy modal */
                height: 250px;
                /* możesz też zmniejszyć wysokość, jeśli chcesz */
            }
        }
        
        @media (max-width: 400px) {
            #player-frame {
                width: 300px;
                /* węższy modal */
                height: 500px;
                /* możesz też zmniejszyć wysokość, jeśli chcesz */
            }
            #player-toggle button {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            /* Jeśli chcesz też minimalizowany widok modala dla telefonu */
            #player-frame.minimized {
                width: 280px;
                height: 70px;
            }
            #mini-player {
                bottom: 27px !important;
                left: 64px !important;
            }
        }
        
        #mini-player {
            background: #0a5c3f;
            position: fixed;
            opacity: 90%;
            bottom: 32px;
            left: 75px;
            color: white;
            font-size: 14px;
            font-family: sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 240px;
            padding: 6px 10px;
            border-radius: 10px;
            backdrop-filter: blur(6px);
            overflow: hidden;
            white-space: nowrap;
            transition: max-width 0.3s ease, padding 0.3s ease;
            z-index: 9997;
        }
        
        #mini-track {
            overflow: hidden;
            flex: 1;
            min-width: 130px;
            opacity: 80%;
            text-shadow: black 0.1em 0.1em 0.2em;
        }
        
        #mini-text {
            display: inline-block;
            padding-left: 100%;
            animation: scrollText 12s linear infinite;
        }
        
        @keyframes scrollText {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(-100%);
            }
        }
        
        #mini-controls button {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        #mini-controls button:hover {
            opacity: 1;
            transform: scale(1.1);
            /* delikatne powiększenie */
        }
        /* gdy zwinięte → tylko strzałka */
        
        #mini-player.collapsed {
            max-width: 45px;
            padding: 6px;
            gap: 0;
        }
        
        #mini-track,
        #mini-controls {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        #mini-player.collapsed #mini-track,
        #mini-player.collapsed #mini-controls {
            display: none;
            /* chowamy tekst i kontrolki */
        }
        
        #mini-toggle {
            background: none;
            opacity: 90%;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        #mini-toggle:hover {
            opacity: 1;
            transform: scale(1.1);
            /* delikatne powiększenie */
        }
    </style>
    <script>
        dragElement(document.getElementById("player-frame"));

        function dragElement(elmnt) {
            let pos1 = 0,
                pos2 = 0,
                pos3 = 0,
                pos4 = 0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>

<body>
    <div id="player-toggle">
        <button onclick="togglePlayer()">
            <i class="fas fa-music"></i>
        </button>
    </div>
    <div id="mini-player" class="collapsed">
        <div id="mini-track">
            <span id="mini-text">Brak utworu</span>
        </div>
        <div id="mini-controls">
            <button onclick="parentPrevTrack()"><i class="fas fa-backward-step"></i></button>
            <button onclick="parentTogglePlayPause()"><i class="fas fa-play"></i></button>
            <button onclick="parentNextTrack()"><i class="fas fa-forward-step"></i></button>
        </div>
        <button id="mini-toggle" onclick="toggleMiniPlayer()">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>



    <iframe id="content-frame"></iframe>
    <iframe src="Muzyka.html" id="player-frame"></iframe>

    <!-- ... pozostała część HEAD/HTML bez zmian ... -->

    <script>
        const player = document.getElementById("player-frame");
        const toggleButton = document.querySelector("#player-toggle button");
        const contentFrame = document.getElementById("content-frame");

        // Nowe, klarowne API do sterowania modalem (używamy klasy .open)
        function openPlayer() {
            player.classList.add('open');
        }

        function closePlayer() {
            player.classList.remove('open');
        }

        function togglePlayer() {
            if (player.classList.contains('open')) closePlayer();
            else openPlayer();
        }

        function toggleMiniPlayer() {
            const mini = document.getElementById("mini-player");
            const toggleBtn = document.getElementById("mini-toggle").querySelector("i");

            mini.classList.toggle("collapsed");

            if (mini.classList.contains("collapsed")) {
                toggleBtn.classList.remove("fa-chevron-left");
                toggleBtn.classList.add("fa-chevron-right");
            } else {
                toggleBtn.classList.remove("fa-chevron-right");
                toggleBtn.classList.add("fa-chevron-left");
            }
        }

        // Zapobiegaj propagacji kliknięć wewnątrz modala — dzięki temu kliknięcia w player nie zamkną go
        player.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Kliknięcia w całym dokumencie rodzica - zamyka modal gdy klik poza przyciskiem i poza samym playerem
        document.addEventListener('click', function(event) {
            if (player.classList.contains('open') &&
                event.target !== toggleButton &&
                !toggleButton.contains(event.target) &&
                event.target !== player &&
                !player.contains(event.target)
            ) {
                closePlayer();
            }
        });


        // Zaktualizowane playDeluxAlbum: otwiera modal przez openPlayer(), a nie przez style.display
        function playDeluxAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("delux");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Delux', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Delux w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playArcticAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("arctic");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Arktyczny', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Arktyczny w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playSouthAmericaAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("southamerica");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Ameryka Południowa', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Ameryka Południowa w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playAustraliaAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("australia");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Australia', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Australia w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playAquaticAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("aquatic");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Wodny', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Wodny w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playSoutheastAsiaAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("southeastasia");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Azja Południowo-Wschodnia', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Azja Południowo-Wschodnia w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playAfricaAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("africa");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Afryka', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Afryka w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playNorthAmericaAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("northamerica");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Ameryki Północnej', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Ameryki Północnej w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playEuropeAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("europe");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Europa', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Europa w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playConservationAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("conservation");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Ochrona przyrody', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Ochrona przyrody w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playTwilightAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("twilight");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Zmierzch', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Zmierzch w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playGrasslandsAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("grasslands");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Stepy', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Stepy w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playTropicalAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("tropical");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Tropiki', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Tropiki w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playAridAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("arid");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Klimatu suchego', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Klimatu suchego w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playOceaniaAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("oceania");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Oceania', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Oceania w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }

        function playEurasiaAlbum() {
            openPlayer(); // zawsze otwórz modal

            const musicFrame = player.contentWindow;
            if (musicFrame) {
                try {
                    // znajdź element albumu Delux w iframe muzyki
                    const deluxParent = musicFrame.document.getElementById("eurasia");
                    const deluxElement = deluxParent ? deluxParent.querySelector(".album") : null;

                    if (deluxElement && typeof musicFrame.playAlbum === "function") {
                        musicFrame.playAlbum('Pakiet Eurazja', deluxElement);
                    } else {
                        console.warn("Nie znaleziono funkcji playAlbum lub elementu Pakiet Eurazja w iframe muzyki.");
                    }
                } catch (err) {
                    console.warn("Nie można uzyskać dostępu do zawartości playera (CORS?).", err);
                }
            }
        }
    </script>


    <!-- Funkcja do zmiany favicon (usuwa stare linki i dodaje nowe) -->
    <script>
        function setFavicon(href) {
            if (!href) return;
            // usuń stare
            const oldIcons = document.querySelectorAll('link[rel~="icon"], link[rel="shortcut icon"], link[rel="apple-touch-icon"]');
            oldIcons.forEach(i => i.parentNode && i.parentNode.removeChild(i));
            // dodaj standardową ikonę i shortcut (kompatybilność)
            const link = document.createElement('link');
            link.rel = 'icon';
            link.href = href + (href.indexOf('?') === -1 ? '?v=' + Date.now() : '&v=' + Date.now()); // wymusza przeładowanie cache
            document.head.appendChild(link);

            const shortcut = document.createElement('link');
            shortcut.rel = 'shortcut icon';
            shortcut.href = link.href;
            document.head.appendChild(shortcut);
        }

        /* --- Obsługa 1: jeśli iframe jest same-origin -> spróbuj odczytać jego link[rel*="icon"] lub mapowanie na podstawie URL --- */

        function applyFaviconFromIframe() {
            try {
                const cw = contentFrame.contentWindow;
                const doc = cw.document;
                // najpierw spróbuj pobrać favicon z dokumentu iframe (jeśli tam jest ustawione)
                const iconEl = doc.querySelector('link[rel*="icon"]');
                if (iconEl && iconEl.href) {
                    setFavicon(iconEl.href);
                    return;
                }
                // jeśli nie ma, możemy mapować po URL (przykład)
                const url = cw.location.href || contentFrame.src;
                mapUrlToFavicon(url);
            } catch (err) {
                // cross-origin lub inny błąd
                console.warn("Nie udało się odczytać iframe (prawdopodobnie CORS).", err);
                // fallback: użyj src a jeśli to cross-origin, poproś o postMessage (zobacz niżej)
                mapUrlToFavicon(contentFrame.src);
            }
        }

        /* --- Obsługa 2: mapowanie URL -> favicon (dostosuj mapę do swoich plików) --- */
        function mapUrlToFavicon(url) {
            if (!url) return;
            // proste dopasowania na podstawie nazwy pliku w URL
            if (url.includes('Arctic Pack') || url.includes('Arctic%20Pack')) {
                setFavicon('Ikony/ArcticPack.png');
            } else if (url.includes('Strona%20g%C5%82%C3%B3wna') || url.includes('Strona główna') || url.includes('Strona%20glowna')) {
                setFavicon('Ikony/Planet Zoo.png'); // domyślny
            } else if (url.includes('InnaStrona.html')) {
                setFavicon('Ikony/InnaIkona.png');
            } else {
                // fallback — domyślny
                setFavicon('Ikony/Planet Zoo.png');
            }
        }

        /* --- Obsługa 3: postMessage - gdy iframe jest cross-origin lub chcesz jawnie sterować --- */
        window.addEventListener('message', (ev) => {
            // dla bezpieczeństwa możesz sprawdzić ev.origin
            try {
                const data = typeof ev.data === 'string' ? JSON.parse(ev.data) : ev.data;
                if (data && data.type === 'setFavicon' && data.href) {
                    setFavicon(data.href);
                }
                if (data && data.type === 'setTitle' && data.title) {
                    document.title = data.title;
                }
            } catch (err) {
                // jeżeli ev.data nie jest JSON — spróbuj użyć jako obiekt bez parsowania
                const data = ev.data;
                if (data && data.type === 'setFavicon' && data.href) setFavicon(data.href);
            }
        }, false);

        /* --- Podpinamy load handler iframe --- */
        contentFrame.addEventListener('load', () => {
            // odpal logikę próbującą pobrać favicon / mapować url
            applyFaviconFromIframe();

            // dodatkowo: spróbuj pobrać tytuł iframe (jeśli same-origin)
            try {
                const title = contentFrame.contentDocument && contentFrame.contentDocument.title;
                if (title) document.title = title + ' ';
            } catch (err) {
                // cross-origin: nic nie rób
            }
        });


        /* --- Opcjonalnie: ustaw favicon początkowo --- */
        document.addEventListener('DOMContentLoaded', () => {
            // favicon domyślny
            setFavicon('Ikony/Planet Zoo.png');
        });

        // które strony cachujemy (podaj dokładne nazwy plików — tak, z odstępami i myślnikiem)
        const cachePages = [
            'Zoopedia.html',
            'Aktualizacje.html',
            'Aktualizacje - konsola.html', // <-- tutaj wpisz swoją nazwę
            'DLC.html',
            'DLC - konsola.html',
            'Informacje dnia.html',
            'Muzyka.html'
        ];

        const iframeCache = new Map(); // mapa: klucz = canonicalBasename, wartość = iframe element

        function normalizeName(name) {
            if (!name) return '';
            // zdekoduj (zmienia %20 itp.), usuń białe znaki na końcach, zmniejsz litery
            try {
                name = decodeURIComponent(name);
            } catch (e) {}
            return name.trim().toLowerCase();
        }

        window.addEventListener("message", (ev) => {
            if (ev.data.type === "songUpdate") {
                document.getElementById("mini-text").textContent =
                    ev.data.title;

                const btnIcon = document.querySelector("#mini-controls button:nth-child(2) i");
                if (ev.data.isPlaying) {
                    btnIcon.classList.remove("fa-play");
                    btnIcon.classList.add("fa-pause");
                } else {
                    btnIcon.classList.remove("fa-pause");
                    btnIcon.classList.add("fa-play");
                }
            }
        });

        function parentTogglePlayPause() {
            document.getElementById("player-frame").contentWindow
                .postMessage({
                    type: "togglePlayPause"
                }, "*");
        }

        function parentNextTrack() {
            document.getElementById("player-frame").contentWindow
                .postMessage({
                    type: "nextTrack"
                }, "*");
        }

        function parentPrevTrack() {
            document.getElementById("player-frame").contentWindow
                .postMessage({
                    type: "prevTrack"
                }, "*");
        }
    </script>
    <script>
        function parentPrevTrack() {
            try {
                const musicFrame = document.getElementById("player-frame").contentWindow;
                if (musicFrame && typeof musicFrame.prevMusic === "function") {
                    musicFrame.prevMusic(); // tak jak przycisk #prev w Muzyka.html
                }
            } catch (err) {
                console.warn("Prev track error:", err);
            }
        }

        function parentNextTrack() {
            try {
                const musicFrame = document.getElementById("player-frame").contentWindow;
                if (musicFrame && typeof musicFrame.nextMusic === "function") {
                    musicFrame.nextMusic(); // tak jak przycisk #next w Muzyka.html
                }
            } catch (err) {
                console.warn("Next track error:", err);
            }
        }

        function parentTogglePlayPause() {
            try {
                const musicFrame = document.getElementById("player-frame").contentWindow;
                if (musicFrame && typeof musicFrame.playPauseMusic === "function") {
                    musicFrame.playPauseMusic();
                }
            } catch (err) {
                console.warn("Play/pause error:", err);
            }
        }
    </script>

    <script>
        (function() {
            // helpery
            function getFrame() {
                return document.getElementById('content-frame');
            }

            function basenameFromUrl(url) {
                try {
                    const u = new URL(url, location.href);
                    return decodeURIComponent(u.pathname.split('/').pop());
                } catch (e) {
                    const parts = url.split('/');
                    const raw = parts[parts.length - 1].split('?')[0].split('#')[0];
                    try {
                        return decodeURIComponent(raw);
                    } catch (e2) {
                        return raw;
                    }
                }
            }

            function attachCommonHandlers(iframe) {
                if (!iframe) return;

                iframe.addEventListener('load', () => {
                    const doc = iframe.contentDocument || (iframe.contentWindow && iframe.contentWindow.document);
                    if (!doc) return;

                    // zawsze dodawaj nowy handler do nowo załadowanego dokumentu
                    doc.addEventListener('click', function(e) {
                        if (e.target && e.target.closest && e.target.closest('[data-parent-opener]')) return;

                        let el = e.target;
                        while (el && el !== doc) {
                            const onclick = el.getAttribute && el.getAttribute('onclick');
                            if (onclick && (/parent\.openPlayer|parent\.togglePlayer|parent\.playDeluxAlbum|parent\.playArcticAlbum|parent\.playSouthAmericaAlbum|parent\.playAustraliaAlbum|parent\.playAquaticAlbum|parent\.playSoutheastAsiaAlbum|parent\.playAfricaAlbum|parent\.playNorthAmericaAlbum|parent\.playEuropeAlbum|parent\.playConservationAlbum|parent\.playTwilightAlbum|parent\.playGrasslandsAlbum|parent\.playTropicalAlbum|parent\.playAridAlbum|parent\.playOceaniaAlbum|parent\.playEurasiaAlbum/).test(onclick)) {
                                return;
                            }
                            el = el.parentNode;
                        }

                        try {
                            const player = document.getElementById("player-frame");
                            if (player.classList.contains('open')) {
                                player.classList.remove('open');
                            }
                        } catch (ignore) {}
                    }, {
                        capture: true
                    });
                });


                iframe.addEventListener('load', () => {
                    // próbujemy ustawić favicon (bez wyrzucania błędów przy CORS)
                    try {
                        const cw = iframe.contentWindow;
                        const doc = cw && cw.document;
                        if (doc) {
                            const iconEl = doc.querySelector && doc.querySelector('link[rel*="icon"]');
                            if (iconEl && iconEl.href) {
                                setFavicon(iconEl.href);
                            } else {
                                mapUrlToFavicon(cw.location && cw.location.href ? cw.location.href : iframe.src);
                            }
                        } else {
                            mapUrlToFavicon(iframe.src);
                        }
                    } catch (err) {
                        console.warn("applyFaviconFromIframe (safe) błąd:", err);
                        mapUrlToFavicon(iframe.src);
                    }

                    // --- Zapisujemy resolved URL (preferuj full href) ---
                    let resolvedUrl;
                    try {
                        // jeśli same-origin, weź rzeczywisty location.href wewnątrz iframe
                        const cw = iframe.contentWindow;
                        if (cw && cw.location && cw.location.href) {
                            resolvedUrl = cw.location.href;
                        } else {
                            resolvedUrl = new URL(iframe.src, location.href).href;
                        }
                    } catch (e) {
                        try {
                            resolvedUrl = new URL(iframe.src, location.href).href;
                        } catch (e2) {
                            resolvedUrl = iframe.src;
                        }
                    }

                    try {
                        const prev = sessionStorage.getItem('lastPageUrl') || sessionStorage.getItem('lastPage') || '';
                        if (prev !== resolvedUrl) {
                            sessionStorage.setItem('lastPageUrl', resolvedUrl);
                            sessionStorage.setItem('lastPageBasename', basenameFromUrl(resolvedUrl));
                            console.log("💾 Zapisano lastPageUrl:", resolvedUrl);
                        } else {
                            console.log("⏩ lastPageUrl nie zmienione:", resolvedUrl);
                        }
                    } catch (err) {
                        console.warn("Błąd przy zapisie lastPageUrl:", err);
                    }

                    // attach click handler *inside* iframe (bez throw gdy cross-origin)
                    try {
                        const doc = iframe.contentDocument || (iframe.contentWindow && iframe.contentWindow.document);
                        if (doc && !iframe.__clickHandlerAttached) {
                            doc.addEventListener('click', function(e) {
                                // wyjątek: element z data-parent-opener
                                if (e.target && e.target.closest && e.target.closest('[data-parent-opener]')) return;

                                // wyjątek: kliknięcie w element z onclick otwierającym playera
                                let el = e.target;
                                while (el && el !== doc) {
                                    const onclick = el.getAttribute && el.getAttribute('onclick');
                                    if (onclick && (/parent\.openPlayer|parent\.togglePlayer|parent\.playDeluxAlbum|parent\.playArcticAlbum|parent\.playSouthAmericaAlbum|parent\.playAustraliaAlbum|parent\.playAquaticAlbum|parent\.playSoutheastAsiaAlbum|parent\.playAfricaAlbum|parent\.playNorthAmericaAlbum|parent\.playEuropeAlbum|parent\.playConservationAlbum|parent\.playTwilightAlbum|parent\.playGrasslandsAlbum|parent\.playTropicalAlbum|parent\.playAridAlbum|parent\.playOceaniaAlbum|parent\.playEurasiaAlbum/).test(onclick)) {
                                        return;
                                    }
                                    el = el.parentNode;
                                }

                                // domyślnie: zamknij playera
                                try {
                                    const player = document.getElementById("player-frame");
                                    if (player.classList.contains('open')) {
                                        player.classList.remove('open');
                                    }
                                } catch (ignore) {}
                            }, {
                                capture: true
                            });
                            iframe.__clickHandlerAttached = true;
                        }

                    } catch (err) {
                        // cross-origin albo brak dostępu do dokumentu — nic nie robimy
                    }
                });
            }

            function replaceWithIframe(newIframe) {
                newIframe.id = 'content-frame';
                const old = getFrame();
                if (old && old.parentNode) {
                    old.parentNode.replaceChild(newIframe, old);
                } else {
                    const player = document.getElementById('player-frame');
                    if (player && player.parentNode) player.parentNode.insertBefore(newIframe, player);
                    else document.body.appendChild(newIframe);
                }
                attachCommonHandlers(newIframe);
            }

            // Nadpisujemy changePage, żeby zawsze aktualizować sessionStorage i reattachować handlery
            window.changePage = function(url) {
                const frame = getFrame();
                if (!frame) return console.warn("Brak elementu #content-frame");

                try {
                    frame.style.opacity = 0;
                } catch (e) {}

                // zapisujemy resolved absolute URL (fallback do zapisu 'lastPage' jeśli coś pójdzie nie tak)
                try {
                    const abs = new URL(url, location.href).href;
                    sessionStorage.setItem('lastPageUrl', abs);
                    sessionStorage.setItem('lastPageBasename', basenameFromUrl(abs));
                    console.log("🔀 changePage - zapisano lastPageUrl:", abs);
                } catch (err) {
                    try {
                        sessionStorage.setItem('lastPage', url);
                    } catch (e2) {}
                    console.warn("changePage - nie udało się zapisać lastPageUrl, zapisano fallback 'lastPage':", err);
                }

                const basename = basenameFromUrl(url);
                const key = normalizeName(basename);

                if (typeof isCachePage === 'function' && isCachePage(url)) {
                    if (iframeCache.has(key)) {
                        const cached = iframeCache.get(key);
                        replaceWithIframe(cached);
                        requestAnimationFrame(() => cached.style.opacity = 1);
                    } else {
                        const newIframe = document.createElement('iframe');
                        newIframe.src = url;
                        newIframe.style.width = '100%';
                        newIframe.style.height = '101vh';
                        newIframe.style.border = 'none';
                        newIframe.style.opacity = 0;
                        iframeCache.set(key, newIframe);
                        replaceWithIframe(newIframe);
                        newIframe.addEventListener('load', () => {
                            newIframe.style.transition = 'opacity 0.2s ease-in-out';
                            newIframe.style.opacity = 1;
                        });
                    }
                } else {
                    const current = getFrame();
                    if (current && current.tagName && current.tagName.toLowerCase() === 'iframe') {
                        current.src = url;
                    } else {
                        const newIframe = document.createElement('iframe');
                        newIframe.src = url;
                        newIframe.style.width = '100%';
                        newIframe.style.height = '101vh';
                        newIframe.style.border = 'none';
                        newIframe.style.opacity = 0;
                        replaceWithIframe(newIframe);
                        newIframe.addEventListener('load', () => newIframe.style.opacity = 1);
                    }
                }
            };

            // Inicjalizacja przy starcie
            document.addEventListener('DOMContentLoaded', () => {
                let iframe = getFrame();
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.id = 'content-frame';
                    const player = document.getElementById('player-frame');
                    if (player && player.parentNode) player.parentNode.insertBefore(iframe, player);
                    else document.body.appendChild(iframe);
                }
                attachCommonHandlers(iframe);

                // najpierw sprawdzamy nowy klucz, potem kompatybilnie stare
                const fromUrl = sessionStorage.getItem('lastPageUrl') || sessionStorage.getItem('lastPage') || sessionStorage.getItem('lastPageBasename');
                console.log("📂 (init) lastPage z sessionStorage:", fromUrl);

                if (fromUrl && fromUrl.trim() !== '') {
                    try {
                        // ustawiamy bezpośrednio (jeśli basename, browser rozwiąże jako relative URL)
                        iframe.src = fromUrl;
                        console.log("🔄 Przywracam ostatnią stronę:", fromUrl);
                    } catch (e) {
                        try {
                            iframe.src = new URL(fromUrl, location.href).href;
                            console.log("🔄 Przywracam (resolved) ostatnią stronę:", fromUrl);
                        } catch (e2) {
                            console.warn("Nie udało się ustawić lastPage — ładuję domyślną stronę", e2);
                            iframe.src = "Strona główna.html";
                        }
                    }
                } else {
                    console.log("📄 Brak zapisanej strony — ustawiam domyślną");
                    iframe.src = "Strona główna.html";
                }
            });
        })();
    </script>



</body>

</html>